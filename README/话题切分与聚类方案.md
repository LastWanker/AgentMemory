# 话题切分与聚类方案（默认执行版）

更新时间：2026-02-21  
定位：这是聊天记忆处理器的“算法规划文档”，不涉及具体代码实现。

---

## 1. 目标（和项目主线对齐）

1. 从聊天记录中提取用户发言并保序。
2. 自动判断“明显换话题”的位置（尽量不靠拍脑袋阈值）。
3. 将同一事件聚成 cluster（cluster 内互为候选正例）。
4. 支持 listwise 场景：同 cluster 候选里做靠前排序。
5. 支持“生成可能提问形式（query）”且优先低成本方案（非必须依赖 LLM）。

---

## 2. 总体流程（三段）

1. 会话内切分（session internal segmentation）
2. 会话内聚类（session internal clustering）
3. 跨会话合并（optional, cross-session linking）

说明：  
- 默认先只做会话内，保证稳定与可解释。  
- 跨会话不是禁区，但作为第二阶段能力，避免一开始噪声过大。

---

## 3. 自动“换话题”判定（不靠固定死阈值）

### 3.1 推荐方法：变化点检测（主）

对每个会话构造相邻距离序列：
- `d_t = 1 - cos(e_t, e_(t-1))`
- `e_t` 是 turn 句向量（可用现有 HF/E5 句向量）。

在 `d_t` 上做 change point detection（如 PELT/Binseg 思路）。  
输出断点集 `B = {t1, t2, ...}`，每个断点代表主题段落切换候选。

优点：
- 比“固定 0.35”稳健。
- 能利用整段统计结构，而不是单点抖动。

### 3.2 兜底方法：会话内自适应阈值（辅）

如果暂不接变化点检测算法，则用会话内分位阈值：
- `thr_session = quantile(d_t, q)`，如 `q=0.9`
- `d_t > thr_session` 时标记断裂候选

再加一个新词比例条件，减少误报。

---

## 4. 聚类策略（先稳后强）

### 4.1 会话内聚类（默认）

分段后在每段内聚类：
- 输入：段内 turn 向量
- 方法：密度聚类（HDBSCAN 思路）或层次聚类
- 输出：`cluster_id`

原则：
- 同 cluster 的 turn 互为候选正例。
- 每个 turn 都可单独作为 query。

### 4.2 跨会话合并（可选增强）

不禁止跨会话，但默认延后。  
做法：先拿每个 cluster 的中心向量，再做二次聚类。

约束（防误合）：
- 语义相似高 + 关键词重叠高 + 时间分布合理，才合并。
- 合并动作应可回滚（保留原 cluster_id 和 merged_cluster_id）。

---

## 5. Query 生成：优先低成本反推，不强依赖 LLM

你的想法成立：cluster 完成后可“反推可能提问形式”。

### 5.1 非 LLM 方案（默认先做）

从 cluster 内自动生成 query 候选：
1. 关键词模板：`谁/什么/为什么/怎么做/结果如何`
2. 角色变换：陈述句 -> 疑问句
3. 同义词替换：基于词典或 embedding 邻近词
4. 省略与口语化：短问法、关键词问法

这些 query 用于：
- 训练增强（query augmentation）
- 离线回放评估（看 cluster 是否能被不同表达召回）

### 5.2 LLM 方案（可选）

只在非 LLM 方案覆盖不足时使用，且做抽样而非全量。  
目标是“补盲”，不是“全量生成”。

---

## 6. 与 listwise 的对齐方式

对于每个 query：
1. 候选池优先来自同 cluster（正例密集区）。
2. 可混入邻近 cluster 的 hard negatives（提高排序分辨率）。
3. listwise 训练目标聚焦“正例集合排序靠前”。

这与当前项目主线一致：
- cluster 是候选生成器
- reranker 负责候选内部排序

---

## 7. 接口预留（思想留痕）

建议后续在配置层保留这些键（先写文档，不强制现在实现）：

- `segmentation.method`: `changepoint | adaptive_threshold`
- `segmentation.min_segment_len`
- `segmentation.quantile_q`
- `clustering.method`: `hdbscan | hierarchical`
- `clustering.min_cluster_size`
- `cross_session.enable`
- `cross_session.merge_threshold`
- `query_expand.enable`
- `query_expand.method`: `template | lexical | llm`
- `query_expand.max_queries_per_cluster`

---

## 8. 结论（本轮讨论后的默认执行）

1. 先做会话内自动切分 + 会话内聚类（稳定优先）。
2. cluster 内互为候选正例，直接服务 listwise。
3. query 扩展先用低成本规则反推，不必先上 LLM。
4. 跨会话合并作为二阶段增强，不是禁用项。

这条路线不幼稚，也不想当然，属于可落地的工程路径。

